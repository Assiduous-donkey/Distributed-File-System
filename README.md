# 分布式文件系统

## 项目规划

### 项目框架

采用客户端-服务器模型，设置目录服务器和文件服务器。目录服务器记录文件的所在服务器，文件服务器存储独立文件，向客户端提供整个文件。客户端请求文件时首先访问目录服务器，获取文件当前的位置，再根据取得的位置访问文件服务器请求对应的文件。每个文件服务器配备一个备份服务器，备份服务器存储它对应的主文件服务器上的文件，使文件有多个副本，且仅与它对应的主文件服务器交互，以确保数据的可用性。主文件服务器与客户端交互，提供基础的文件操作。
<img src="photo/初步框架.png" width = "480" height = "480"/>

#### 客户端的文件操作

1. 下载文件：先访问目录服务器获取文件所在的文件服务器，再去对应的文件服务器上下载文件到本地。

2. 上传文件：先访问目录服务器获取要上传的文件所在的文件服务器，若文件不存在则用调度算法选择一个文件服务器作为存储该文件的对象然后返回地址给客户端，若文件存在则直接返回文件所在地给客户端，然后客户端再将文件上传到对应的服务器

3. 删除文件：先检查本地目录是否有该文件，有则删除。再访问目录服务器获取要删除的文件所在的文件服务器，然后告诉对应的文件服务器删除哪个文件

4. 创建目录：先访问目录服务器，由目录服务器调度文件服务器创建目录，再由目录服务器由消息反馈给客户端

用户读文件，实际上需要先下载文件，然后自己再在本地打开文件。
用户新建文件，实际上先自己的本地新建然后再上传到文件服务器。
用户写文件，实际上需要先下载文件，然后自己在本地打开文件修改，修改完成再上传。

因此服务器只需要提供文件下载、文件上传和文件删除的功能即可。

#### 服务端的文件操作

1. 下载文件：获取文件内容然后传输给客户端，若主文件服务器找不到文件，则去对应的备份服务器找。若找到则将备份服务器的文件传给主文件服务器，然后主文件服务器再传给客户端。若找不到则然后错误信息。

2. 上传文件：接收客户端传来的数据，包括文件名、文件内容，然后创建或修改文件服务器以及备份服务器对应文件的内容

3. 删除文件：若文件不存在则返回文件不存在的消息，若文件存在则在文件服务器上删除文件然后返回删除结果给客户端，**并告知目录服务器删除对应的记录**。注意主文件服务器和备份服务器都要删除。

4. 创建目录：文件服务器收到目录服务器的命令后在本地创建目录，返回创建信息给目录服务器，目录服务器收到成功的消息后在本地创建记录，再将消息传递给客户端。

上面的功能看起来像是一个FTP服务器。因为没有考虑多用户读写的情况。
要确定用户写操作互斥，以及并行读且保证读取的内容一致，需要对文件加锁。
**在此种框架下，文件加锁操作由文件服务器执行，分为读锁和写锁**。

#### 并行读

多用户可以同时下载同一版本的文件，有用户读时（指的是用户从服务器上下载文件的过程）其他用户不可提交。当无用户处于下载过程时可以上传（即写操作）。

#### 互斥写

有用户提交时，在提交过程中其他用户不可提交

#### 读写操作

实际上的读操作是下载操作
实际上的写操作是上传操作

#### 通信方式

1. 节点之间都采用**RPC**方式通信：客户端——目录服务器、目录服务器——文件服务器、客户端——文件服务器、文件服务器——备份服务器

2. 各项操作采用同步通信

#### 容错

主服务器失效时由备份服务器顶替成为主服务器，顶替过程中不可被用户访问。失效服务器重启后成为备份服务器，与主文件服务器进行数据同步，这一过程也不可被用户访问。
问题在于怎么判断主文件服务器失效。一个简单的方法是若对于该服务器的连续N（一个阈值）个请求都是无效的，则认为该服务器失效，为此可以在目录服务器上添加记录，记录该服务器上连续的无效请求次数。

#### 安全性

1. 目录服务器单点失效，可以为目录服务器也提供一个备份服务器。

2. 目录服务器上的记录可以存缓存和磁盘，因此可以采用Redis数据库，Redis运行在内存中但可以将数据持久化到磁盘上。存到磁盘上可以防止掉电丢失等意外情况。

#### 文件存储

采用目录结构，遵从以下规则：

1. 同一目录下不能有同名文件

2. 不能有同名目录

#### 交互方式

客户端在控制台运行客户端程序之后通过输入指令来执行操作，命令格式如下：
